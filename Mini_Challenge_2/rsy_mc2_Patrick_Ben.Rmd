---
title: "RSY-MC2"
author: "Patrick, Ben"
output: 
  html_notebook:
    toc: True
    toc_float: True
---

# Settings
```{r}
library(tidyverse)
library(recommenderlab)
```


# 1. Erzeugung von Film- & Nutzerprofilen

## 1.1 MovieLense Daten einlesen

```{r}
data(MovieLense)
```

## 1.2 Binäre User-Liked-Items Matrix für alle Nutzer erzeugen.

```{r}
as(MovieLense[1:4, 1:4], "matrix")

user_liked_items_binaer <- binarize(MovieLense, minRating = 4)

as(user_liked_items_binaer[1:4, 1:4], "matrix")
```

## 1.3 Dimension der User-Liked-Items Matrix prüfen und ausgeben.

```{r}
dim(user_liked_items_binaer)
```
Die User-Liked-Items Matrix hat eine Dimension von 943 User und 1664 Items (Movies). 

## 1.4 Movie-Genre Matrix für alle Filme erzeugen.

```{r}
Movie_Genre_df <- MovieLenseMeta %>% select(-c(year, url))

Movie_genre_matrix <- as(Movie_Genre_df, "matrix")

Movie_genre_matrix[1:5, 1:6]
```

## 1.5 Dimension der Movie-Genre Matrix prüfen und ausgeben.

```{r}
dim(Movie_genre_matrix)
```
Die Movie_genre_Matrix hat eine Dimension von 1664 User und 20 Genre. 

## 1.6 Anzahl unterschiedlicher Filmprofile bestimmen und visualisieren.

```{r}
Movie_genre_matrix_renamed <- Movie_genre_matrix

colnames <- colnames(Movie_genre_matrix)[-1]

for (colname in colnames) {
  Movie_genre_matrix_renamed[, colname] <- ifelse(Movie_genre_matrix[, colname] == 1, colname, NA)
}

Movie_genre_renamed_df <- as.data.frame(Movie_genre_matrix_renamed)

rownames(Movie_genre_renamed_df) <- Movie_genre_renamed_df[, 1]

Movie_genre_renamed_df <- Movie_genre_renamed_df %>% select(-c(title))

Movie_genre_concat_df <- Movie_genre_renamed_df %>% unite("profile", sep = "-", na.rm = TRUE, remove = TRUE)

Movie_genre_concat_df 

Movie_genre_concat_df %>% group_by(profile) %>% summarise(Anzahl = n()) %>% arrange(desc(Anzahl)) %>% head(30) %>% arrange(profile) %>% 
ggplot(aes(x = Anzahl, y = profile, fill = "red")) + 
  ggtitle("Anzahl unterschiedlicher Filmprofile") +
  geom_bar(stat = "identity") + 
  theme(legend.position="none")

```

## 1.7 Nutzerprofile im Genre-Vektorraum erzeugen.

```{r}

user_rating_df <- as(MovieLense, "data.frame")

user_rating_genre_df <- left_join(user_rating_df, Movie_Genre_df, by = c("item" = "title"))

user_rating_genre_df

```

```{r}
multiplied_rating_genre <- cbind(user_rating_genre_df$user, sapply(user_rating_genre_df[4:22], "*", user_rating_genre_df$rating))
```


```{r}
multiplied_rating_genre_df <- as.data.frame(multiplied_rating_genre) %>% rename(user = V1)

multiplied_rating_genre_df
```


```{r}
# change every column except first one to int
for (colname in colnames(multiplied_rating_genre_df)[-1]) {
  multiplied_rating_genre_df[, colname] <- as.integer(multiplied_rating_genre_df[, colname])
}

# replace all 0 with NA
#multiplied_rating_genre_df[multiplied_rating_genre_df == 0] <- NA

# groupby user and calculate mean of every column 
user_genre_profile_df <- multiplied_rating_genre_df %>% group_by(user) %>% summarise_all(mean, na.rm = TRUE) %>% arrange(user) %>% column_to_rownames(., var = "user")

user_genre_profile_df

```



## 1.8 Dimension der User-Genre-Profil Matrix prüfen und ausgeben.

```{r}
dim(user_genre_profile_df)
```
Wie zu erwarten haben wir weiterhin 943 User und 19 Genre. 


## 1.9 Anzahl unterschiedlicher Nutzerprofile bestimmen, wenn Stärke der

Genre-Kombination (a) vollständig (b) binär berücksichtigt wird.

```{r}

```

# 2. Ähnlichkeit von Nutzern und Filmen

## 2.1 Cosinus-Ähnlichkeit zwischen User-Genre- und Movie-Genre-Matrix berechnen.

```{r}
head(user_genre_profile_df, n = 3)

# remove first col in Movie_Genre_df
movie_genre_df <- Movie_Genre_df %>% 
  select(c(-1)) 

head(movie_genre_df, n = 3)

# turn both dataframe into a r matrix

user_genre_matrix <- as.matrix(user_genre_profile_df)
movie_genre_matrix <- as.matrix(movie_genre_df)

# create small testing matrices
test_user_genre_matrix <- user_genre_matrix[1:5, 1:5]
test_user_genre_matrix

test_movie_genre_matrix <- movie_genre_matrix[1:5, 1:5]
test_movie_genre_matrix

```

```{r}

z_test = test_user_genre_matrix %*% t(test_movie_genre_matrix)
z_test

user_genre_rowsums <- sqrt(rowSums(test_user_genre_matrix**2))
movie_genre_rowsums <- sqrt(rowSums(test_movie_genre_matrix**2))

user_genre_rowsums 
movie_genre_rowsums

n_test = user_genre_rowsums %*% t(movie_genre_rowsums)
n_test

z_test / n_test
```



```{r}
cosine_sim_func <- function(user_genre_matrix, movie_genre_matrix){
  # matrix multiplication of user_genre_matrix @ movie_genre_matrix.T
  # User Movie Matrix: A x B.T
  zaehler = user_genre_matrix %*% t(movie_genre_matrix)
  
  # calculating the sqrt(sum(x^2, row matrix)) of each matrix and get a vector
  user_genre_sqrt_rowsum_x2 <- sqrt(rowSums(user_genre_matrix ** 2))
  movie_genre_sqrt_rowsum_x2 <- sqrt(rowSums(movie_genre_matrix ** 2))
  
  # now we create a matrix out of those two vectors
  # User Movie Matrix: ||A|| x ||B||.T
  nenner = user_genre_sqrt_rowsum_x2 %*% t(movie_genre_sqrt_rowsum_x2)
  
  # calculate Cosine similarity
  user_movie_cosine_sim_matrix = zaehler / nenner
  
  user_movie_cosine_sim_matrix 
  
}


cosine_sim_func(test_user_genre_matrix, test_movie_genre_matrix)
```

```{r}
cosine_sim_matrix <- cosine_sim_func(user_genre_matrix, movie_genre_matrix)
View(cosine_sim_matrix)
```


## 2.2 Dimension der Matrix der Cosinus-Ähnlichkeiten von Nutzern und Filmen prüfen und ausgeben.

```{r}
dim(cosine_sim_matrix)
```

## 2.3 5-Zahlen Statistik für Matrix der Cosinus-Ähnlichkeiten prüfen und ausgeben.

```{r}
cosine_sim_vector <- as.vector(cosine_sim_matrix)

summary(cosine_sim_vector)
```

## 2.4 Cosinus-Ähnlichkeiten von Nutzern und Filmen mit Dichteplot visualisieren.

```{r}
cosine_sim_vector_density <- density(cosine_sim_vector)

plot(cosine_sim_vector_density, lwd = 2, col = "red",
     main = "Density")
```

## 2.5 Cosinus-Ähnlichkeiten von Nutzern und Filmen mit Dichteplot für

Nutzer "241", "414", "477", "526", "640" und "710" visualisieren.

```{r}
cosine_sim_matrix_user <- cosine_sim_matrix[c(241, 414, 477, 526, 640, 710),]

df_cosine_sim_matrix <- as.data.frame(cosine_sim_matrix_user)

df_cosine_sim_matrix

df_cosine_sim_matrix <- df_cosine_sim_matrix %>% 
  rownames_to_column("user_id")

df_cosine_sim_matrix_long <- df_cosine_sim_matrix %>% 
  gather(genre, cosine_sim, -user_id)

df_cosine_sim_matrix_long

ggplot(df_cosine_sim_matrix_long, aes(x = cosine_sim, fill = user_id)) +
  geom_density(alpha = 0.1) +
  labs(title = "Dichteplot von verschiedenen User",
       x = "Cosine Similarity",
       y = "Density")
```


# 3. Empfehlbare Filme

## 3.1 Bewertete Filme maskieren, d.h. "Negativabzug" der User-Items Matrix erzeugen, um anschliessend Empfehlungen herzuleiten.

```{r}

```

## 3.2 Zeilensumme des "Negativabzuges" der User-Items Matrix für die

User "5", "25", "50" und "150" ausgeben.

```{r}

```

## 3.3 5-Zahlen Statistik der Zeilensumme des "Negativabzuges" der UserItems Matrix bestimmen.

```{r}

```

# 4. Top-N Empfehlungen

## 4.1 Matrix für Bewertung aller Filme durch element-weise

Multiplikation der Matrix der Cosinus-Ähnlichkeiten von Nutzern und Filmen und "Negativabzug" der User-Items Matrix erzeugen.

```{r}

```

## 4.2 Dimension der Matrix für die Bewertung aller Filme prüfen.

```{r}

```

## 4.3 Top-20 Listen extrahieren und Länge der Listen pro Nutzer prüfen.

```{r}

```

## 4.4 Verteilung der minimalen Ähnlichkeit für Top-N Listen für N = 10, 20, 50, 100 für alle Nutzer visuell vergleichen.

```{r}

```

## 4.5 Top-20 Empfehlungen für Nutzer "5", "25", "50", "150" visualisieren.

```{r}

```

## 4.6 Für Nutzer "133" und "555" Profil mit Top-N Empfehlungen für N = 20, 30, 40, 50 analysieren, visualisieren und diskutieren.

```{r}

```
